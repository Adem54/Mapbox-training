<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Matrix API ‚Äî En Yakƒ±n Noktalar (ETA Sƒ±ralƒ±)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Mapbox GL JS -->
<link href="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js"></script>
  <!-- Geocoder (adres arama) -->

  
  
    {/* Geocoder plugin */}
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1-dev/mapbox-gl-geocoder.min.js"></script>
<link
  rel="stylesheet"
  href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1-dev/mapbox-gl-geocoder.css"
  type="text/css"
/>
  
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #app { display:grid; grid-template-columns: 360px 1fr; height:100vh; }
    #sidebar { border-right:1px solid #e5e7eb; padding:12px; overflow:auto; }
    #map { width:100%; height:100%; }
    .item { padding:10px; border:1px solid #e5e7eb; border-radius:10px; margin-bottom:8px; cursor:pointer; }
    .item:hover { background:#f8fafc; }
    .title { font-weight:600; }
    .eta { font-size:12px; opacity:0.8; }
    .legend { font-size:12px; color:#6b7280; margin:8px 0 6px; }
    .btn { display:inline-block; padding:6px 10px; border-radius:8px; border:1px solid #e5e7eb; cursor:pointer; margin:6px 0; }
    .btn:hover { background:#f8fafc; }
    .pill { display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; margin-left:6px; }
  </style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <div id="geocoder"></div>
    <div class="legend">Ba≈ülangƒ±√ß: geocoder‚Äôdan adres se√ß veya ‚ÄúKonumumu kullan‚Äù de.</div>
    <div class="btn" id="useMe">üìç Konumumu kullan</div>
    <div class="legend">Hedefler (Oslo √∂rnekleri)</div>
    <div id="list"></div>
  </div>
  <div id="map"></div>
</div>

<script>
  // 1) TOKEN ‚Äî kendi public token‚Äôinle deƒüi≈ütir
	mapboxgl.accessToken = 'pk.eyJ1IjoiYWRlbS01NCIsImEiOiJjbWFsM3R4d2MwNGtmMmpzZnk2ZW5tcGRsIn0.aCSC5Pe3IUcHI8MDeCTwxw';


  // 2) OSLO √∂rnek hedefler (max 9 hedef: 1 origin + 9 destinasyon = 10 koordinat limiti)
  const destinations = [
    { id:'dest-0', name:'Oslo Sentrum (R√•dhus)',   coord:[10.7330,59.9133] },
    { id:'dest-1', name:'Oslo S (Merkez ƒ∞stasyon)',coord:[10.7530,59.9112] },
    { id:'dest-2', name:'Frogner Park',            coord:[10.7069,59.9270] },
    { id:'dest-3', name:'MUNCH Museum',            coord:[10.7634,59.9050] },
    { id:'dest-4', name:'Ullev√•l Stadion',         coord:[10.7360,59.9483] },
    { id:'dest-5', name:'Gr√ºnerl√∏kka (Olav Ryes)', coord:[10.7595,59.9221] }
  ];

  // 3) Harita
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [10.744, 59.916], zoom: 12.2
  });

  // Geocoder (adres arama)
  const geocoder = new MapboxGeocoder({
    accessToken: mapboxgl.accessToken,
    mapboxgl,
    marker: false,
    countries: 'no',
    language: 'tr'
  });
  document.getElementById('geocoder').appendChild(geocoder.onAdd(map));

  // Origin marker & Dest markers
  let origin = { name:'', coord: [10.744, 59.916] }; // varsayƒ±lan merkez (kullanƒ±cƒ± deƒüi≈ütirecek)
  let originMarker = new mapboxgl.Marker({color:'#0ea5e9'}).setLngLat(origin.coord).addTo(map);

  const destMarkers = [];
  function addDestMarkers(){
    destinations.forEach(d => {
      const m = new mapboxgl.Marker({color:'#ef4444'}).setLngLat(d.coord)
        .setPopup(new mapboxgl.Popup().setText(d.name))
        .addTo(map);
      destMarkers.push(m);
    });
  }

  // 4) Matrix √ßaƒürƒ±sƒ± (sources=origin, destinations=poi‚Äôler)
  async function fetchMatrixAndRender() {
    const coords = [origin.coord, ...destinations.map(d => d.coord)]
      .map(c => `${c[0]},${c[1]}`).join(';');

    // sources=0 (origin), destinations=1..N
    const destIdx = Array.from({length: destinations.length}, (_,i)=>i+1).join(';');
    const url = `https://api.mapbox.com/directions-matrix/v1/mapbox/driving-traffic/${coords}` +
                `?sources=0&destinations=${destIdx}&annotations=duration` +
                `&access_token=${mapboxgl.accessToken}`;

    const res = await fetch(url);
    const data = await res.json();

    if (data.code !== 'Ok') {
      console.error('Matrix error:', data);
      document.getElementById('list').innerHTML = `<div class="item">Hata: ${data.code}</div>`;
      return;
    }

    // durations[0] => origin -> her destinasyon i√ßin s√ºre (saniye)
    const durations = data.durations && data.durations[0] ? data.durations[0] : [];
    const enriched = destinations.map((d, i) => ({
      ...d,
      durSec: durations[i] // null olabilir (route yok)
    })).filter(d => d.durSec != null)
      .sort((a,b) => a.durSec - b.durSec);

    renderList(enriched);
  }

  function fmtMin(sec){
    if (sec == null) return '‚Äî';
    const m = Math.round(sec/60);
    return m < 1 ? `${Math.round(sec)} sn` : `${m} dk`;
  }

  // 5) Liste + tƒ±klandƒ±ƒüƒ±nda Directions ile rota √ßiz
  async function drawRoute(toCoord){
    const coords = `${origin.coord[0]},${origin.coord[1]};${toCoord[0]},${toCoord[1]}`;
    const url = `https://api.mapbox.com/directions/v5/mapbox/driving-traffic/${coords}` +
                `?geometries=geojson&steps=false&access_token=${mapboxgl.accessToken}`;
    const r = await fetch(url).then(r => r.json());
    const route = r.routes?.[0]?.geometry;
    if (!route) return;

    if (map.getLayer('route-line')) map.removeLayer('route-line');
    if (map.getSource('route-src')) map.removeSource('route-src');

    map.addSource('route-src', { type:'geojson', data: route });
    map.addLayer({
      id:'route-line', type:'line', source:'route-src',
      paint:{ 'line-width': 6, 'line-color': '#2563eb', 'line-opacity': 0.9 }
    });

    // Kamerayƒ± rotaya uydur
    const bbox = route.coordinates.reduce((b,c)=>b.extend(c), new mapboxgl.LngLatBounds(route.coordinates[0], route.coordinates[0]));
    map.fitBounds(bbox, { padding: 60, duration: 700 });
  }

  function renderList(rows){
    const list = document.getElementById('list');
    list.innerHTML = '';
    rows.forEach((r, idx) => {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<div class="title">${idx+1}. ${r.name} <span class="pill">ETA: ${fmtMin(r.durSec)}</span></div>
                       <div class="eta">(${r.coord[0].toFixed(4)}, ${r.coord[1].toFixed(4)})</div>`;
      div.onclick = () => drawRoute(r.coord);
      list.appendChild(div);
    });
  }

  // 6) Geocoder se√ßimi ‚Üí origin g√ºncelle + Matrix hesapla
  geocoder.on('result', ev => {
    origin = { name: ev.result.place_name, coord: ev.result.center };
    originMarker.setLngLat(origin.coord);
    fetchMatrixAndRender();
  });

  // 7) ‚ÄúKonumumu kullan‚Äù (https zorunlu olabilir; lokalde bazƒ± tarayƒ±cƒ±lar izin vermez)
  document.getElementById('useMe').onclick = () => {
    if (!navigator.geolocation) return alert('Geolocation desteklenmiyor.');
    navigator.geolocation.getCurrentPosition(pos => {
      origin.coord = [pos.coords.longitude, pos.coords.latitude];
      originMarker.setLngLat(origin.coord);
      map.easeTo({ center: origin.coord, zoom: 13 });
      fetchMatrixAndRender();
    }, err => alert('Konum alƒ±namadƒ±: ' + err.message), { enableHighAccuracy:true, timeout:10000 });
  };

  // 8) Harita y√ºklendiƒüinde hedef marker‚Äôlarƒ± ekle ve ilk hesap
  map.on('load', () => {
    addDestMarkers();
    // ƒ∞lk hesap (varsayƒ±lan origin ile)
    fetchMatrixAndRender();
  });
</script>
</body>
</html>
<!-- 

se√ßtiƒüin ba≈ülangƒ±√ß noktasƒ±na g√∂re Oslo‚Äôdaki √∂rnek noktalarƒ± ETA‚Äôya (saniye) g√∂re sƒ±ralayan bir liste g√∂receksin. Listeden bir hedefe tƒ±klarsan Directions API ile rotayƒ± da √ßizer.
Not: mapbox/driving-traffic profili kullanƒ±yorum (trafik etkili s√ºre). Matrix, geometri d√∂nd√ºrmez; bu y√ºzden rota √ßizimi i√ßin tƒ±klamada ek olarak Directions √ßaƒürƒ±yorum.

Sol listede hedefler ETA‚Äôya g√∂re sƒ±ralanacak. Birine tƒ±klarsan haritada rota √ßizilir.
ƒ∞pucu: mapbox/driving-traffic ile maksimum 10 koordinat sƒ±nƒ±rƒ± var (1 origin + 9 hedef). Daha √ßok hedef varsa, gruplara b√∂l√ºp birden √ßok Matrix isteƒüi at ve sonu√ßlarƒ± birle≈ütir. Ayrƒ±ca domain kƒ±sƒ±tƒ±yla token‚Äôƒ±nƒ± korumayƒ± unutma (Account ‚Üí Tokens ‚Üí Allowed URLs).


Ne yapƒ±yoruz?
Se√ßtiƒüin ba≈ülangƒ±√ß konumundan (geocoder veya ‚ÄúKonumumu kullan‚Äù)
Birden fazla hedefe (√∂rnek Oslo noktalarƒ±) trafik d√¢hil seyahat s√ºresini (ETA) hesaplƒ±yoruz ‚Üí Matrix API
Bu hedefleri ETA‚Äôya g√∂re sƒ±ralƒ±yoruz (en √ßabuk ula≈üƒ±lacak olan en √ºstte).
Listeden birine tƒ±klayƒ±nca o hedefe ger√ßek g√ºzerg√¢hƒ± √ßizdiriyoruz ‚Üí Directions API (geometri + ETA).
Kƒ±saca: ‚ÄúNereye en hƒ±zlƒ± giderim?‚Äù sorusunu anƒ±nda cevaplƒ±yoruz; sonra da ‚ÄúNasƒ±l giderim?‚Äù sorusunu g√∂rsel rota ile tamamlƒ±yoruz.


Bu size hangi problemi √ß√∂z√ºyor?
Zaman‚Äìmesafe doƒüru kƒ±yas: Hava √ßizgisi mesafesi deƒüil, yol ko≈üullarƒ±na g√∂re s√ºre. Tek y√∂n, d√∂n√º≈ü kƒ±sƒ±tlarƒ± ve trafik hesaba katƒ±lƒ±r.

Hƒ±zlƒ± karar: ‚Äú≈ûimdi sƒ±radaki en mantƒ±klƒ± hedef hangisi?‚Äù 1‚Äì2 API √ßaƒürƒ±sƒ±yla netle≈üir.

Operasyonel verim: Kurye/teknisyen bir sonraki i≈üi en yakƒ±n (s√ºreye g√∂re) se√ßer ‚Üí km ve s√ºre d√º≈üer, on-time artar.

Kullanƒ±cƒ± deneyimi: ‚ÄúBana en yakƒ±n maƒüaza/istasyon hangisi?‚Äù ‚Äî liste zaten ETA artan sƒ±rada hazƒ±r.

Tƒ±klayƒ±nca rota: Karar verdikten sonra anƒ±nda g√ºzerg√¢h √∂nizlemesi (talimat/ETA ile).


Hangi senaryolarda doƒürudan i≈üe yarar?

Dispatch / saha hizmeti: 10 s√ºr√ºc√ºden hangisi yeni i≈üi almalƒ±? (Matrix ile s√ºre tablosu ‚Üí en d√º≈ü√ºk).

Kurye/Daƒüƒ±tƒ±m: Yeni paket geldi; mevcut konumdan hangi teslimata ge√ßmeliyim?

Store locator: M√º≈üteriye ‚Äúyakƒ±nƒ±mdaki maƒüazalar‚Äùƒ± yol s√ºresi sƒ±rasƒ±na g√∂re g√∂ster, tƒ±klayƒ±nca rota √ßƒ±kar.

Acil durum/yardƒ±m: En hƒ±zlƒ± ula≈üacak ekip hangisi?


Neden Matrix + Directions (Optimization deƒüil)?

Matrix API: ‚ÄúBir origin ‚Üí √ßok hedef‚Äù (ya da birka√ß origin ‚Üî birka√ß hedef) s√ºre/maliyet kar≈üƒ±la≈ütƒ±rmasƒ± i√ßin en hƒ±zlƒ± yol. Geometri d√∂nmez; kƒ±yas i√ßin idealdir.

Directions API: Karar verdikten sonra tek rotayƒ± √ßizmek/ETA g√∂stermek i√ßin.

Optimization v1/v2: Bir aracƒ±n birden √ßok duraƒüƒ± en iyi sƒ±rayla gezmesi (v1) veya √ßok ara√ß + kƒ±sƒ±tlarla filonun planƒ± (v2) i√ßin. Yani ‚Äúsƒ±radaki tek hedef‚Äù yerine ‚Äút√ºm g√ºn√ºn planƒ±‚Äù gerektiƒüinde.

Sƒ±ralama neden √∂nemli?
Zihinsel y√ºk√º ortadan kaldƒ±rƒ±r. Operat√∂r√ºn tek tek haritaya bakƒ±p tahmin y√ºr√ºtmesine gerek kalmaz; en hƒ±zlƒ±dan en yava≈üa otomatik dizilir.

(Kodda) ≈üunu yapƒ±yoruz:

const enriched = destinations
  .map((d,i) => ({ ...d, durSec: durations[i] }))
  .filter(d => d.durSec != null)
  .sort((a,b) => a.durSec - b.durSec); // k√º√ß√ºkten b√ºy√ºƒüe

  B√∂ylece liste ETA k√º√ß√ºkten b√ºy√ºƒüe gelir; tƒ±klayƒ±nca Directions‚Äôla rota g√∂r√ºn√ºr.


  Geli≈ütirme fikirleri (hemen √ºst√ºne koyabileceƒüin ≈üeyler)

  Daha fazla hedef: driving-traffic profilinde 10 koordinat limiti var ‚Üí hedefleri 9‚Äôluk gruplara b√∂l, sonu√ßlarƒ± birle≈ütir.

Depart_at (gelecek trafik): ‚Äú30 dk sonra √ßƒ±karsam?‚Äù hesabƒ± i√ßin depart_at parametresi (beta) ile Matrix/Directions‚Äôtan gelecek zaman trafiƒüi kullan.

Ger√ßek zamanlƒ± yenileme: Origin deƒüi≈ütik√ße (ara√ß hareket ediyorsa) olay bazlƒ± tekrar Matrix √ßaƒüƒ±r ‚Üí liste otomatik g√ºncellensin.

Atama: Birden fazla s√ºr√ºc√ºn varsa, Matrix‚Äôten gelen maliyet matrisi ile Hungarian algoritmasƒ±yla optimal s√ºr√ºc√º‚Äìi≈ü e≈üle≈ütirmesi yap.

Uber-tarzƒ± ‚Äúyolcuya en yakƒ±n taksi‚Äù veya ‚Äúen yakƒ±n taksi duraƒüƒ±‚Äù gibi senaryolarda √ßok i≈üe yarar:
Yolcu (tek nokta) ‚Üí bir√ßok s√ºr√ºc√º: Matrix ile 1√óN s√ºreleri hesapla, en k√º√ß√ºk s√ºre hangi s√ºr√ºc√ºdeyse ona ata.
Yolcu ‚Üí taksi duraklarƒ±/POI: POI‚Äôleri (kendi listen ya da Mapbox Search/Category ‚Äútaxi stand‚Äù) al; Matrix‚Äôle ETA‚Äôya g√∂re sƒ±rala.

Uber-benzeri ‚Äúen yakƒ±n s√ºr√ºc√ºy√º ata‚Äù ‚Äì tarif & √∂rnek
Adƒ±mlar (re√ßete)

S√ºr√ºc√ºlerinin canlƒ± konumlarƒ±nƒ± (lon,lat) backend‚Äôde tut.

Yolcu konumu geldiƒüinde hava mesafesiyle en yakƒ±n 9 s√ºr√ºc√ºy√º √∂n-ele (√ß√ºnk√º driving-traffic profilinde Matrix max 10 koordinat: 1 yolcu + 9 s√ºr√ºc√º).

Matrix API (driving-traffic) ile sources=0 (yolcu), destinations=1..N (s√ºr√ºc√ºler): s√ºreleri al.

min( duration ) olan s√ºr√ºc√ºy√º se√ß ‚Üí dispatch et.

Se√ßilen s√ºr√ºc√º i√ßin Directions API ile rota + ETA √ºret, uygulamaya g√∂nder (veya Navigation SDK).
Matrix √ßaƒürƒ±sƒ± (1 yolcu ‚Üí 4 s√ºr√ºc√º √∂rneƒüi)


GET https://api.mapbox.com/directions-matrix/v1/mapbox/driving-traffic/
  10.7522,59.9139; 10.7600,59.9200; 10.7400,59.9150; 10.7700,59.9100; 10.7550,59.9250
  ?sources=0
  &destinations=1;2;3;4
  &annotations=duration
  &access_token=YOUR_TOKEN


  K√º√ß√ºk se√ßim fonksiyonu (JS)

  const drivers = [
  {id:'d1', coord:[10.7600,59.9200]},
  {id:'d2', coord:[10.7400,59.9150]},
  {id:'d3', coord:[10.7700,59.9100]},
  {id:'d4', coord:[10.7550,59.9250]}
];
// matrixResponse.durations[0] -> [214,168,255,201]
function pickBestDriver(durations, drivers){
  let bestIdx = -1, best = Infinity;
  durations.forEach((sec, i) => { if (sec!=null && sec<best){ best=sec; bestIdx=i; }});
  return bestIdx >= 0 ? { driver: drivers[bestIdx], etaSec: best } : null;
}

(ƒ∞steƒüe baƒülƒ±) Rota √ßizimi

Se√ßtiƒüin s√ºr√ºc√º i√ßin Directions:

GET https://api.mapbox.com/directions/v5/mapbox/driving-traffic/
  {lon_driver},{lat_driver};{lon_rider},{lat_rider}
  ?geometries=geojson&steps=true&language=tr
  &access_token=YOUR_TOKEN


  ‚ÄúEn yakƒ±n taksi duraƒüƒ±/POI‚Äù i√ßin

Kendi POI listen varsa: Matrix ile origin ‚Üí √ßok POI ETA‚Äôlarƒ±nƒ± al, k√º√ß√ºkten b√ºy√ºƒüe sƒ±rala, tƒ±klamada Directions √ßiz.

Genel POI arayacaksan: Mapbox Search (Category Search) ile ‚Äútaxi stand‚Äù yakƒ±nlarƒ±nda POI √ßek, sonra Matrix‚Äôle ETA re-rank yap.

Optimization v1/v2 nerede devreye girer?

Matrix + Directions: Tek seferlik atama (yeni bir i≈ü/yolcu) i√ßin en hƒ±zlƒ±, hafif √ß√∂z√ºm.

Optimization v1: Tek ara√ß + birden √ßok durak sƒ±ralamasƒ± (k√º√ß√ºk turlar).

Optimization v2: √áok ara√ß + kƒ±sƒ±tlar (vardiya, kapasite, zaman penceresi) ile g√ºnl√ºk plan. Ride-hailing‚Äôde ‚Äú√ßok yolcuyu/√ßok s√ºr√ºc√ºye payla≈ütƒ±rƒ±p √ßoklu duraklƒ± rotalar‚Äù gibi planlama varsa d√º≈ü√ºn√ºl√ºr; anlƒ±k tek atama i√ßin Matrix yeterlidir.
-->