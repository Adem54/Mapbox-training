<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Mapbox – Araç Takip (Tırtıklı İz, Rota Önceden Yok)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js"></script>
  <style>
    html,body,#map { height:100%; margin:0 }
    .legend{
      position:absolute; z-index:1; top:10px; left:10px; background:#fff; padding:8px 10px;
      border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.1);
      font:14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif
    }
    .car {
      width:36px; height:36px;
      background-repeat:no-repeat; background-position:center; background-size:contain;
      background-image:url('data:image/svg+xml;utf8,<svg width="64" height="64" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><g fill="none" stroke="none"><rect x="20" y="6" width="24" height="52" rx="8" fill="%23006EE6"/><rect x="23" y="10" width="18" height="12" rx="3" fill="%23B3D4FF"/><rect x="23" y="42" width="18" height="12" rx="3" fill="%239DC6FF"/><circle cx="22" cy="18" r="3" fill="%23222"/><circle cx="42" cy="18" r="3" fill="%23222"/><circle cx="22" cy="46" r="3" fill="%23222"/><circle cx="42" cy="46" r="3" fill="%23222"/><rect x="18" y="26" width="28" height="12" rx="2" fill="%230055B3"/></g></svg>');
      transform-origin: 50% 50%;
      filter: drop-shadow(0 1px 4px rgba(0,0,0,.4));
    }
  </style>
</head>
<body>
<div id="map"></div>
<div class="legend">
  Space: Başlat/Durdur • F: Follow kamera<br>
  Rota önceden çizilmez; sadece <b>tırtıklı iz</b> kalır.
</div>

<script>
	mapboxgl.accessToken = 'pk.eyJ1IjoiYWRlbS01NCIsImEiOiJjbWFsM3R4d2MwNGtmMmpzZnk2ZW5tcGRsIn0.aCSC5Pe3IUcHI8MDeCTwxw';


  // 1) Kavisli temel rota (DC civarı örnek)
  const baseRoute = [
    [-77.0925, 38.9400],
    [-77.0820, 38.9340],
    [-77.0700, 38.9290],
    [-77.0600, 38.9255],
    [-77.0500, 38.9230],
    [-77.0430, 38.9220],
    [-77.0370, 38.9218],
    [-77.0320, 38.9225],
    [-77.0280, 38.9242],
    [-77.0240, 38.9270],
    [-77.0215, 38.9305],
    [-77.0200, 38.9345],
    [-77.0202, 38.9385],
    [-77.0225, 38.9420],
    [-77.0285, 38.9442],
    [-77.0365, 38.9455],
    [-77.0450, 38.9450],
    [-77.0520, 38.9428],
    [-77.0585, 38.9392]
  ];

  // --- Yardımcılar: mesafe (haversine), bearing, interpolate, densify ---
  const toRad = d => d * Math.PI / 180;
  function haversine(a,b){
    const R=6371000, [lon1,lat1]=a, [lon2,lat2]=b;
    const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
    const s=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return 2*R*Math.asin(Math.sqrt(s));
  }
  function interpolate(a,b,t){ return [ a[0]+(b[0]-a[0])*t, a[1]+(b[1]-a[1])*t ]; }
  function densifyLine(coords, stepMeters=50){
    const out=[coords[0]];
    for(let i=0;i<coords.length-1;i++){
      const a=coords[i], b=coords[i+1];
      const d = haversine(a,b);
      const n = Math.max(1, Math.floor(d/stepMeters));
      for(let k=1;k<=n;k++) out.push(interpolate(a,b,k/n));
    }
    return out;
  }
  function bearingDeg(a,b){
    const [lon1,lat1]=a.map(toRad), [lon2,lat2]=b.map(toRad);
    const dLon=lon2-lon1;
    const y=Math.sin(dLon)*Math.cos(lat2);
    const x=Math.cos(lat1)*Math.sin(lat2)-Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);
    return ((Math.atan2(y,x)*180/Math.PI)+360)%360;
  }

  // Rota sıklaştır (daha pürüzsüz hareket)
  const route = densifyLine(baseRoute, 45);

  // 2) Harita
  const map = new mapboxgl.Map({
    container:'map',
    style:'mapbox://styles/mapbox/streets-v12',
    center: route[0],
    zoom: 13
  });

  // 3) Araba marker
  const carEl = document.createElement('div');
  carEl.className = 'car';
  const car = new mapboxgl.Marker({ element: carEl }).setLngLat(route[0]);

  // 4) Yalnızca "ilerlenen iz" kaynağı (başta tek nokta)
  let progressedGeo = {
    type:'Feature',
    geometry:{ type:'LineString', coordinates: [ route[0] ] }
  };

  map.on('load', () => {
    // Tırtıklı iz katmanı
    map.addSource('route-progressed', { type:'geojson', data: progressedGeo });
    map.addLayer({
      id:'route-progressed',
      type:'line',
      source:'route-progressed',
      paint:{
        //'line-color':'#16a34a',
        'line-color':'#2003fc',
        'line-width': 6,
        'line-dasharray': [3, 3],  // tırtıklı görünüm
        'line-opacity': 0.95
      }
    });

    // Hafif glow (opsiyonel) – sadece iz için, ön rota yok
    map.addLayer({
      id:'route-progressed-glow',
      type:'line',
      source:'route-progressed',
      paint:{
        'line-color':'#22c55e',
        'line-width': 12,
        'line-opacity': 0.18,
        'line-blur': 6
      }
    }, 'route-progressed'); // altta kalsın

    // Marker’ı ekle
    car.addTo(map);

    // Kamera başlangıç
    const bounds = new mapboxgl.LngLatBounds();
    route.forEach(c => bounds.extend(c));
    map.fitBounds(bounds, { padding: 60 });

    // 5) Simülasyon
    let idx = 0;
    let playing = true;
    let follow = false;   // F ile aç/kapat
    const stepMs = 100;  // 1 saniye

    function step(){
      if(!playing) return;
      if(idx >= route.length-1) return;

      const from = route[idx];
      const to   = route[idx+1];

      // bearing ile arabayı döndür
      const br = bearingDeg(from, to);
      carEl.style.transform = `rotate(${br}deg)`;

      // marker'ı animasyonla taşı
      animateMarker(from, to, stepMs*0.9);

      // iz güncelle
      progressedGeo.geometry.coordinates.push(to);
      map.getSource('route-progressed').setData(progressedGeo);

      // follow modu
      if(follow) map.easeTo({ center: to, duration: stepMs*0.9 });

      idx++;
      setTimeout(step, stepMs);
    }

    function animateMarker(a,b,duration){
      const start = performance.now();
      function frame(now){
        const t = Math.min(1, (now - start)/duration);
        const lng = a[0] + (b[0]-a[0]) * t;
        const lat = a[1] + (b[1]-a[1]) * t;
        car.setLngLat([lng, lat]);
        if(t<1) requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    }

    // başlat
    step();

    // Kısayollar: Space (play/pause), F (follow)
    window.addEventListener('keydown', (e)=>{
      if(e.code === 'Space'){
        playing = !playing;
        if(playing) step();
        e.preventDefault();
      } else if (e.key.toLowerCase() === 'f') {
        follow = !follow;
      }
    });
  });
</script>
</body>
</html>
